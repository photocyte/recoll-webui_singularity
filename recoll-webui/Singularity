Bootstrap: docker
From: ubuntu:19.10
#####Could use ubuntu:20.04, but it doesn't have python-waitress yet.
#####Also note, the newer that is used, the greater the chance of compatability problems w/ older kernels

%labels
MAINTAINER TRF

%files

%environment
    
%post
    apt-get update
    apt-get install locales
    locale-gen "en_US.UTF-8"
    dpkg-reconfigure locales
    apt-get install -y pwgen git nginx xxd apache2-utils nano
    apt-get install -y recoll python3-recoll recollcmd recollgui xvfb python-waitress python-ujson
    git clone https://framagit.org/medoc92/recollwebui.git

    ##Making some files for the basic authentication
    mkdir nginx_private ##Where the key and passwd files are stored
    HEXKEY=$(xxd -l 16 -p /dev/urandom)
    htpasswd -b -B -c /nginx_private/nginx.pwd lab-user ${HEXKEY}
    echo ${HEXKEY} > /nginx_private/hexkey.txt        
    ###
    ###Disable nginx logging, which doesn't play nice w/ the read-only filesystem.
    ###Also put nginx.pid in a writable location.
    sed -i 's/\/var\/log\/nginx\/access.log/off/g' /etc/nginx/nginx.conf
    sed -i 's/\/var\/log\/nginx\/error.log/off/g' /etc/nginx/nginx.conf
    sed -i 's/\/run\/nginx.pid/\/tmp\/recoll-singularity_nginx.pid /etc/nginx/nginx.conf
    
    
%runscript
    exec "$@"
