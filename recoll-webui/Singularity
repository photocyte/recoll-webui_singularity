Bootstrap: docker
From: ubuntu:19.10
#####Could use ubuntu:20.04, but it doesn't have python-waitress yet.
#####Also note, the newer that is used, the greater the chance of compatability problems w/ older kernels

%labels
MAINTAINER TRF

%files

%environment
    
%post
    apt-get update
    apt-get install locales
    locale-gen "en_US.UTF-8"
    dpkg-reconfigure locales
    apt-get install -y pwgen git nginx xxd apache2-utils nano
    apt-get install -y recoll python3-recoll recollcmd recollgui xvfb python-waitress python-ujson
    git clone https://framagit.org/medoc92/recollwebui.git

    ##Making some files for the basic authentication
    BUILDKEY=$(xxd -l 16 -p /dev/urandom) ##This is only unique, for each time the container is built. Should do it as a runscript.
    echo ${BUILDKEY} > /buildkey.txt
    
    ###Disable nginx logging, which doesn't play nice w/ the read-only filesystem.
    ###Also put nginx.pid in a writable location.
    sed -i 's/\/var\/log\/nginx\/access.log/off/g' /etc/nginx/nginx.conf
    sed -i 's/\/var\/log\/nginx\/error.log/off/g' /etc/nginx/nginx.conf
    sed -i "s/\/run\/nginx.pid/\/tmp\/${BUILDKEY}_recoll-singularity_nginx.pid" /etc/nginx/nginx.conf ##This doesn't play nice w/ multiple containers on the same machine
    
%runscript
    #!/bin/bash
    BUILDKEY=`cat /buildkey.txt`
    BASICAUTHUSER="recoll-user"
    RUNKEY=$(xxd -l 16 -p /dev/urandom)
    if [ ! -f "/tmp/${BUILDKEY}_${RUNKEY}.hexkey.txt ]; then
        echo ${HEXKEY} > "/tmp/${RUNKEY}.hexkey.txt"
    fi
    if [ ! -f "/tmp/${BUILDKEY}_${RUNKEY}.nginx.pwd" ]; then
            htpasswd -b -B -c "/tmp/${BUILDKEY}_${RUNKEY}.nginx.pwd" ${BASICAUTHUSER} ${RUNKEY}
    fi
    echo "Basic authentication parameters:"
    echo "Username: ${BASICAUTHUSER}"
    echo "Key: ${RUNKEY}"

