Bootstrap: docker
From: ubuntu:19.10
#####Could use ubuntu:20.04, but it doesn't have python-waitress yet.
#####Also note, the newer that is used, the greater the chance of compatability problems w/ older kernels

%labels
MAINTAINER TRF

%files

%environment
    
%post
    apt-get update
    apt-get install locales
    locale-gen "en_US.UTF-8"
    dpkg-reconfigure locales
    apt-get install -y pwgen git nginx xxd apache2-utils nano
    apt-get install -y recoll python3-recoll recollcmd recollgui xvfb python-waitress python-ujson
    git clone https://framagit.org/medoc92/recollwebui.git

    ##Making some files for the basic authentication
    BASICAUTHUSER="recoll-user"
    echo ${BASICAUTHUSER} > /user.txt
    BUILDKEY=$(xxd -l 16 -p /dev/urandom) ##This is only unique, for each time the container is built.
    echo ${BUILDKEY} > /buildkey.txt
    
    ###Disable nginx logging, which doesn't play nice w/ the read-only filesystem.
    ###Also put nginx.pid in a writable location.
    sed -i 's/\/var\/log\/nginx\/access.log/off/g' /etc/nginx/nginx.conf
    sed -i 's/\/var\/log\/nginx\/error.log/off/g' /etc/nginx/nginx.conf
    sed -i "s/\/run\/nginx.pid/\/tmp\/${BUILDKEY}_recoll-singularity_nginx.pid/g" /etc/nginx/nginx.conf ##This doesn't play nice w/ multiple containers on the same machine
    htpasswd -b -B -c "/tmp/${BUILDKEY}.nginx.pwd" ${BASICAUTHUSER} ${BUILDKEY}
    
    ##There must be an easier way to do this...
    sed -i "s/include \/etc\/nginx\/sites-enabled\/*;\n}\/include \/etc\/nginx\/sites-enabled\/*;\n\nserver { \
      listen 13338; \
      location \/ { \
      root \/dev\/null; \
      } \
      location \/${BUILDKEY}\/ { \
      root \/dev\/null; \
      auth_basic 'Authorized users only'; \
      auth_basic_user_file \/tmp\/${BUILDKEY}.nginx.pwd; \
      proxy_pass http:\/\/127.0.0.1:4567\/; \
      proxy_intercept_errors on; \
      proxy_connect_timeout 8; \
      proxy_read_timeout 180; \
      }\n}\n}/g" /etc/nginx/nginx.conf ##Add the reverse proxy configuration.
    
%runscript
    #!/bin/bash
    BUILDKEY=`cat /buildkey.txt`
    BASICAUTHUSER=`cat /user.txt`
    echo "Basic authentication parameters:"
    echo "Username: ${BASICAUTHUSER}"
    echo "Key: ${BUILDKEY}"

